# Design OS - Architecture

## Folder Structure

```
design-os/
├── .claude/
│   ├── commands/design-os/           - Claude Code slash commands (10 commands)
│   │   ├── product-vision.md         - define product identity
│   │   ├── product-roadmap.md        - break into sections
│   │   ├── data-model.md             - define entities/relationships
│   │   ├── design-tokens.md          - choose colors/typography
│   │   ├── design-shell.md           - design app layout
│   │   ├── shape-section.md          - define section scope
│   │   ├── sample-data.md            - generate data + types
│   │   ├── design-screen.md          - create React components
│   │   ├── screenshot-design.md      - capture screenshots
│   │   └── export-product.md         - generate handoff package
│   └── skills/frontend-design/
│       └── SKILL.md                  - design quality guidelines
├── .github/
│   ├── workflows/
│   │   ├── pr-decline.yml            - automated PR decline system
│   │   └── stale.yml                 - stale issue cleanup
│   ├── CONTRIBUTING.md               - contribution guidelines
│   └── PULL_REQUEST_TEMPLATE.md      - PR template
├── docs/                             - project documentation
├── public/                           - static assets
├── src/
│   ├── assets/
│   │   └── react.svg                 - static asset
│   ├── components/
│   │   ├── ui/                       - shadcn/ui primitives (14 components)
│   │   ├── AppLayout.tsx             - master layout wrapper
│   │   ├── ProductPage.tsx           - Phase 1: product vision + roadmap
│   │   ├── DataModelPage.tsx         - Phase 2: entities + relationships
│   │   ├── DesignPage.tsx            - Phase 3: design tokens + shell
│   │   ├── SectionsPage.tsx          - Phase 4: all sections overview
│   │   ├── SectionPage.tsx           - Phase 4: single section detail
│   │   ├── ScreenDesignPage.tsx      - screen design preview (resizable iframe)
│   │   ├── ShellDesignPage.tsx       - shell design preview (resizable iframe)
│   │   ├── ExportPage.tsx            - Phase 5: export + download
│   │   ├── PhaseNav.tsx              - top nav phase progression
│   │   ├── PhaseWarningBanner.tsx    - incomplete prereqs warning
│   │   ├── NextPhaseButton.tsx       - CTA to next phase
│   │   ├── StepIndicator.tsx         - vertical step timeline
│   │   ├── ThemeToggle.tsx           - light/dark/system switcher
│   │   ├── EmptyState.tsx            - shows which command to run
│   │   ├── ProductOverviewCard.tsx   - displays product overview data
│   │   ├── SectionsCard.tsx          - displays roadmap sections
│   │   ├── SpecCard.tsx              - displays section spec
│   │   ├── DataCard.tsx              - displays sample data info
│   │   ├── ShellCard.tsx             - displays shell spec info
│   │   └── ScreenDesignsCard.tsx     - lists screen designs
│   ├── lib/
│   │   ├── router.tsx                - React Router definitions (10 routes)
│   │   ├── utils.ts                  - Tailwind cn() utility
│   │   ├── product-loader.ts         - loads /product/*.md files
│   │   ├── section-loader.ts         - loads /product/sections/*/ files
│   │   ├── shell-loader.ts           - loads /product/shell/ + /src/shell/
│   │   ├── data-model-loader.ts      - loads /product/data-model/*.md
│   │   └── design-system-loader.ts   - loads /product/design-system/*.json
│   ├── sections/
│   │   └── .gitkeep                  - user screen designs go here
│   ├── types/
│   │   ├── product.ts                - ProductData, ProductOverview, etc.
│   │   └── section.ts                - SectionData, ParsedSpec, etc.
│   ├── main.tsx                      - application entry point
│   └── index.css                     - global styles, theme, Tailwind config
├── product/                          - user product data (generated by commands)
├── product-plan/                     - export output (generated by /export-product)
├── agents.md                         - agent configuration directives
├── claude.md                         - Claude Code project instructions
├── components.json                   - shadcn/ui registry config
├── vite.config.ts                    - Vite build config
└── package.json                      - dependencies and scripts
```

## Bootstrap Flow

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  index.html  │---->│  main.tsx    │---->│  router.tsx  │---->│  Pages       │
│  (Vite entry)│     │  (React root)│     │  (10 routes) │     │  (AppLayout) │
└──────────────┘     └──────────────┘     └──────────────┘     └──────────────┘
                           |
                     ┌─────┴──────┐
                     │ index.css  │
                     │ (Tailwind, │
                     │  theme)    │
                     └────────────┘
```

1. `index.html` references `src/main.tsx`
2. `main.tsx` creates React root with `<StrictMode>` and `<RouterProvider>`
3. `router.tsx` defines 10 flat routes via `createBrowserRouter`
4. Each page wraps itself in `<AppLayout>` (except fullscreen variants)

No global state providers, no context providers, no React.lazy at root level.

## Routing Structure

```
/                                                          ---->  ProductPage
/data-model                                                ---->  DataModelPage
/design                                                    ---->  DesignPage
/sections                                                  ---->  SectionsPage
/sections/:sectionId                                       ---->  SectionPage
/sections/:sectionId/screen-designs/:screenDesignName      ---->  ScreenDesignPage
/sections/:sectionId/screen-designs/:screenDesignName/fullscreen  ---->  ScreenDesignFullscreen
/shell/design                                              ---->  ShellDesignPage
/shell/design/fullscreen                                   ---->  ShellDesignFullscreen
/export                                                    ---->  ExportPage
```

All routes are flat (no nested `<Outlet>` pattern). The phase progression is:

```
Product ---> Data Model ---> Design ---> Sections ---> Export
  (/)       (/data-model)   (/design)   (/sections)   (/export)
                                            |
                                     /:sectionId
                                            |
                                  /screen-designs/:name
                                            |
                                        /fullscreen
```

## High-Level Component Diagram

```
┌────────────────────────────────────────────────────────────────────────┐
│                            AppLayout                                   │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │ Header: PhaseNav (main pages) | BackButton (sub-pages)         │    │
│  │         + ThemeToggle                                          │    │
│  └────────────────────────────────────────────────────────────────┘    │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │ Main Content: Page Component                                   │    │
│  │  ┌──────────────────────────────────────────────────────┐      │    │
│  │  │ StepIndicator (vertical timeline)                    │      │    │
│  │  │  ┌────────────────────────────────────┐              │      │    │
│  │  │  │ Data Card (Overview/Spec/Data/etc) │              │      │    │
│  │  │  │ OR EmptyState (run /command)       │              │      │    │
│  │  │  └────────────────────────────────────┘              │      │    │
│  │  └──────────────────────────────────────────────────────┘      │    │
│  │  ┌──────────────────────────────────────────────────────┐      │    │
│  │  │ NextPhaseButton (when all steps complete)            │      │    │
│  │  └──────────────────────────────────────────────────────┘      │    │
│  └────────────────────────────────────────────────────────────────┘    │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │ Footer: "Powered by Design OS"                                 │    │
│  └────────────────────────────────────────────────────────────────┘    │
└────────────────────────────────────────────────────────────────────────┘
```

## Screen Design Preview Architecture

```
┌─────────────────────────────────────────────────┐
│ ScreenDesignPage (parent window)                │
│ ┌─────────────────────────────────────────────┐ │
│ │ Header: Back + Breadcrumb + Device Presets  │ │
│ │         + ThemeToggle + Fullscreen link     │ │
│ └─────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────┐ │
│ │ Resizable Container                         │ │
│ │ ┌─────────────────────────────────────────┐ │ │
│ │ │ <iframe src="/fullscreen">              │ │ │
│ │ │ ┌─────────────────────────────────────┐ │ │ │
│ │ │ │ ScreenDesignFullscreen              │ │ │ │
│ │ │ │ ┌─────────────────────────────────┐ │ │ │ │
│ │ │ │ │ <Suspense>                      │ │ │ │ │
│ │ │ │ │   AppShell (if useShell=true)   │ │ │ │ │
│ │ │ │ │     ScreenDesignComponent       │ │ │ │ │
│ │ │ │ └─────────────────────────────────┘ │ │ │ │
│ │ │ └─────────────────────────────────────┘ │ │ │
│ │ └─────────────────────────────────────────┘ │ │
│ └─────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────┘
```

Theme synchronization between parent and iframe via localStorage polling (100ms) + storage events.

## Data Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                    File System (Build Time)                         │
│                                                                     │
│  /product/*.md          /product/sections/*/     /product/shell/    │
│  /product/data-model/   /product/design-system/  /src/sections/     │
│  /src/shell/                                                        │
└───────┬─────────────────────────┬────────────────────────┬──────────┘
        |                         |                        |
        v                         v                        v
┌───────────────┐   ┌─────────────────────┐   ┌───────────────────┐
│product-loader │   │  section-loader     │   │  shell-loader     │
│  imports:     │   │  (independent)      │   │  (spec + comps)   │
│  data-model-  │   │                     │   │                   │
│  loader       │   │  Handles:           │   │                   │
│  design-sys-  │   │  - spec.md          │   │                   │
│  loader       │   │  - data.json        │   │                   │
│  shell-loader │   │  - *.tsx (lazy)     │   │                   │
│               │   │  - *.png            │   │                   │
└───────┬───────┘   └──────────┬──────────┘   └─────────┬─────────┘
        |                      |                        |
        v                      v                        v
┌─────────────────────────────────────────────────────────────────────┐
│                   Page Components                                   │
│                                                                     │
│  useMemo(() => loadProductData(), [])    synchronous, no async      │
│  useMemo(() => loadSectionData(id), [])  no network requests        │
│                                                                     │
│  Data is embedded in the JS bundle via import.meta.glob             │
└─────────────────────────────────────────────────────────────────────┘
```

All data loading is build-time via `import.meta.glob({ eager: true })`. Zero network requests at runtime. The app is a static site that reads from bundled markdown/JSON.

## Loader Pattern

Every loader follows the same pattern:

```
1. Build-time glob
   import.meta.glob('/path/to/files', { eager: true, query: '?raw' })
   ----> Record<string, string>

2. Presence check
   export function has*(): boolean {
     return '/path/to/file' in globRecord
   }

3. Parse function
   export function parse*(raw: string): TypedObject | null {
     // regex-based markdown section extraction
   }

4. Load function
   export function load*(): TypedObject | null {
     const content = globRecord['/path/to/file']
     return content ? parse*(content) : null
   }
```

Loader-specific details:

| Loader               | Source                                 | Format    | Special Behavior                        |
|----------------------|----------------------------------------|-----------|-----------------------------------------|
| product-loader       | /product/*.md                          | Markdown  | Master aggregator, calls all loaders    |
| data-model-loader    | /product/data-model/*.md               | Markdown  | Parses entities + relationships         |
| design-system-loader | /product/design-system/*.json          | JSON      | No ?raw query (auto-parsed by Vite)     |
| shell-loader         | /product/shell/*.md + /src/shell/*.tsx | Mixed     | Spec parsing + lazy component loading   |
| section-loader       | /product/sections/*/ + /src/sections/* | Mixed     | Most complex: 4 glob registries, lazy   |

## Type Hierarchy

```
ProductData
  overview: ProductOverview | null
    name: string
    description: string
    problems: Problem[]
    features: string[]
  roadmap: ProductRoadmap | null
    sections: Section[]
      id: string (slugified title)
      title: string
      description: string
      order: number
  dataModel: DataModel | null
    entities: Entity[]
    relationships: string[]
  designSystem: DesignSystem | null
    colors: ColorTokens | null
    typography: TypographyTokens | null
  shell: ShellInfo | null
    spec: ShellSpec | null
    hasComponents: boolean

SectionData
  sectionId: string
  spec: string | null (raw markdown)
  specParsed: ParsedSpec | null
    title, overview
    userFlows: string[]
    uiRequirements: string[]
    useShell: boolean
  data: Record<string, unknown> | null
  screenDesigns: ScreenDesignInfo[]
    name, path, componentName
  screenshots: ScreenshotInfo[]
    name, path, url
```

## Phase Navigation System

```
┌──────────────────────────────────────────────────────────────────┐
│ PhaseNav (horizontal bar)                                        │
│                                                                  │
│  [Product] ---- [Data Model] ---- [Design] ---- [Sections] ---- [Export]
│     (/)         (/data-model)     (/design)    (/sections)      (/export)
│                                                                  │
│  Status per phase: current | completed (green check) | upcoming  │
└──────────────────────────────────────────────────────────────────┘
```

Phase completion conditions:

| Phase      | Complete When                            |
|------------|------------------------------------------|
| Product    | hasOverview AND hasRoadmap               |
| Data Model | hasDataModel                             |
| Design     | hasDesignSystem OR hasShell              |
| Sections   | At least 1 section has screen designs    |
| Export     | product-plan.zip exists                  |

Within each phase page, `StepIndicator` renders a vertical timeline. Steps follow a waterfall pattern: first incomplete step is "current", everything before is "completed", everything after is "upcoming".

## Module Dependency Graph

```
main.tsx
└── router.tsx
    ├── ProductPage.tsx
    │   ├── product-loader.ts -------> data-model-loader.ts
    │   │                      |-----> design-system-loader.ts
    │   │                      |-----> shell-loader.ts
    │   ├── AppLayout.tsx -----------> PhaseNav.tsx
    │   │                      |-----> ThemeToggle.tsx
    │   ├── ProductOverviewCard.tsx
    │   ├── SectionsCard.tsx
    │   ├── StepIndicator.tsx
    │   ├── NextPhaseButton.tsx
    │   └── EmptyState.tsx
    │
    ├── DataModelPage.tsx
    │   ├── product-loader.ts
    │   ├── AppLayout.tsx
    │   ├── StepIndicator.tsx
    │   ├── NextPhaseButton.tsx
    │   └── EmptyState.tsx
    │
    ├── DesignPage.tsx
    │   ├── product-loader.ts
    │   ├── AppLayout.tsx
    │   ├── StepIndicator.tsx
    │   ├── NextPhaseButton.tsx
    │   └── EmptyState.tsx
    │
    ├── SectionsPage.tsx
    │   ├── product-loader.ts
    │   ├── section-loader.ts
    │   ├── AppLayout.tsx
    │   ├── PhaseWarningBanner.tsx --> product-loader.ts
    │   └── NextPhaseButton.tsx
    │
    ├── SectionPage.tsx
    │   ├── product-loader.ts
    │   ├── section-loader.ts
    │   ├── AppLayout.tsx
    │   ├── PhaseWarningBanner.tsx
    │   ├── SpecCard.tsx
    │   ├── DataCard.tsx
    │   └── StepIndicator.tsx
    │
    ├── ScreenDesignPage.tsx / ScreenDesignFullscreen.tsx
    │   ├── section-loader.ts (lazy component loading)
    │   ├── shell-loader.ts (lazy component loading)
    │   ├── product-loader.ts
    │   └── ThemeToggle.tsx
    │
    ├── ShellDesignPage.tsx / ShellDesignFullscreen.tsx
    │   ├── shell-loader.ts
    │   └── ThemeToggle.tsx
    │
    └── ExportPage.tsx
        ├── product-loader.ts
        ├── section-loader.ts
        └── AppLayout.tsx
```

Key observations:
- `product-loader.ts` is the hub -- imports and re-exports from all other loaders
- `section-loader.ts` is the only loader handling lazy component loading for screen designs
- `shell-loader.ts` handles both spec parsing AND lazy component loading for shell
- No circular dependencies

## Screen Design Rendering Chain

```
ScreenDesignPage
       |
       | renders <iframe src="/fullscreen">
       v
ScreenDesignFullscreen
       |
       | calls loadScreenDesignComponent(sectionId, name)
       |       ----> dynamic import via import.meta.glob (lazy)
       |
       | checks sectionUsesShell(sectionId)
       |       ----> reads spec.md for "shell: false"
       |
       | if useShell && shell components exist:
       |   calls loadAppShell()
       |       ----> ShellWrapper.tsx or AppShell.tsx (lazy)
       v
<Suspense fallback={loading}>
  <AppShellComponent>          (optional, based on spec)
    <ScreenDesignComponent />  (user-authored React component)
  </AppShellComponent>
</Suspense>
```

This is the most sophisticated part of the architecture -- composing user-authored React components (screen designs and shell) at runtime with lazy loading, while respecting per-section configuration.
