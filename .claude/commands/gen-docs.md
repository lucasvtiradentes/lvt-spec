# Gen Docs

Interactive, state-aware command that generates structured project documentation for AI context. 
  - Supports single repo and monorepo. 
  - Tracks progress in a state file so interrupted sessions can resume from where they left off.

```
┌─────────────┐    ┌─────────────┐    ┌──────────────────────────────┐    ┌───────────────┐
│  PHASE 0    │    │  PHASE 1    │    │  PHASE 2                     │    │  PHASE 3      │
│  Resume     │    │  Setup      │    │  Preview Loop                │    │  Generate     │
│             │    │             │    │                              │    │               │
│ read .tmp   │───>│ project     │───>│ 2.1 launch agents → scan     │───>│ write docs/   │
│ resume or   │    │ type?       │    │ 2.2 build preview in .tmp    │    │ from approved │
│ start fresh │    │ parts?      │    │ 2.3 show preview to user     │    │ preview       │
│             │    │ skip docs?  │    │      <loop until "go">       │    │               │
└─────────────┘    └─────────────┘    └──────────────────────────────┘    └───────────────┘
```

## Temp Files

All progress is tracked in `.docs-state.tmp` (single file, no folder needed).

After `Step 1.4` (header only):
```
phase: 2
type: monorepo
parts: apps/api,apps/web,packages/infra
docs: overview,architecture,repo,concepts,db,cicd,rules,guides,features,platform,parts,problems
```

After `Step 2.2` (preview appended, phase stays 2 until user picks "generate"):
```
phase: 2
type: monorepo
parts: apps/api,apps/web,packages/infra
docs: overview,architecture,repo,concepts,db,cicd,rules,guides,features,platform,parts,problems

--- PREVIEW ---

overview.md:
  - project: My App - description here
  - related repos: repo-a, repo-b
  - doc index: 12 files across docs/

features/auth.md:
  - email/password + Google OAuth
  - JWT with refresh rotation
  - role-based: guest, host, admin

features/booking.md:
  - availability check → hold → payment → confirm
  - cancellation policies: flexible, moderate, strict

...etc
```

After `Step 2.4` Option 3 (phase bumped to 3, same preview):
```
phase: 3
type: monorepo
parts: apps/api,apps/web,packages/infra
docs: overview,architecture,repo,concepts,db,cicd,rules,guides,features,platform,parts,problems

--- PREVIEW ---
...same preview content...
```

---

## Phase 0 - Resume Check

1. Check if `.docs-state.tmp` exists in the project root
2. If it EXISTS:
   - Read it and parse the phase number
   - Use `AskUserQuestion` to ask:
     - question: "Found existing gen-docs session at phase {N}. What do you want to do?"
     - options:
       - "Resume from phase {N}" (Recommended)
       - "Start fresh (delete state)"
   - If resume: jump to the saved phase
   - If fresh: delete `.docs-state.tmp`, proceed to `## Phase 1`
3. If it does NOT exist:
   - Proceed to `## Phase 1`

---

## Phase 1 - Setup

### Step 1.1 - Ask project type

Use `AskUserQuestion`:
- question: "What type of project is this?"
- header: "Project type"
- options:
  - label: "Single Repo"
    description: "One language/concern, personal projects, libraries, single-service apps"
  - label: "Monorepo"
    description: "Multiple parts (api, frontend, infra), multi-team, multiple package.json"

### Step 1.2 - Identify parts (MONOREPO only)

Skip this step for single repo.

Do NOT scan or auto-detect parts. Simply output this message and wait for the user to type their answer:

```
List your monorepo parts (one path per line), e.g.:
  apps/api
  apps/web
  packages/infra
```

The user will type the paths. Store the confirmed parts list for use in `Step 1.4` and all agents. Part name is inferred from the last path segment (e.g. `apps/api` → `api`).

### Step 1.3 - Ask which docs to SKIP

All docs are generated by default. Display the numbered list below and ask the user to type which numbers to skip. For monorepo, include items 8-9. For single repo, only show items 1-7.

```
All docs below are generated by default. Type numbers to skip (e.g. "1,3") or press enter to keep all:

1. concepts.md  - domain glossary
2. db.md        - data model, migrations, caching
3. cicd.md      - CI/CD pipelines, deploy workflows
4. guides/      - how-to docs, recipes
5. features/    - one doc per feature
6. rules.md     - principles, conventions
7. problems/    - solved problems log
8. platform/    - integrations, observability          (monorepo only)
9. parts/       - per-part overview + rules + guides   (monorepo only)
```

NOTE: overview.md, architecture.md, and repo.md are ALWAYS generated (not listed).
The full list of docs to generate = all docs MINUS whatever the user skipped.
If user presses enter (skips nothing): all docs are generated (most common case).

### Step 1.4 - Save state

Write `.docs-state.tmp`:
```
phase: 2
type: {monorepo|single}
parts: {comma-separated paths, e.g. apps/api,apps/web - empty for single repo}
docs: {comma-separated list of selected docs}
```

Tell the user: "Setup complete. Selected {N} doc types for {type} project. Launching discovery agents..."

Proceed to `## Phase 2`.

---

## Phase 2 - Preview Loop

This phase builds a compact preview outline. Only 2 discovery agents scan the codebase. The heavy 12-agent generation only happens in Phase 3 when the user says "generate".

### Step 2.1 - Launch 2 Discovery Agents

Launch exactly 2 Explore agents in PARALLEL using `Task` with `subagent_type: "Explore"` and `run_in_background: true`.

Each agent gets in its prompt:
- the project type and parts list
- the list of selected docs (only scan for selected ones)
- the `### Preview Format` template so it returns in the correct format
- if deepening: the current preview content for its doc types, with instruction to find GAPS
- if deepening with direction: the user's focus area

Agent 1 (100-200 lines):
- covers: overview, architecture, repo, concepts, db, cicd
- scan README, package.json (root + per-part), pyproject.toml, go.mod, tsconfig, docker-compose
- scan entry points: main/index files, route definitions, main exports
- grep for type definitions, interfaces, enums, DB models/schemas/entities
- grep for env var references (process.env, os.environ), read .env.example
- read CI workflows (.github/workflows/, .gitlab-ci.yml, Jenkinsfile)
- glob folder structure, identify directory organization
- scan tooling configs: eslint, prettier, husky, lint-staged, commitlint
- read Makefile, package.json scripts, shell scripts in scripts/
- scan for DB config (connection pooling, replicas, migrations, seeds, caching)
- MONOREPO: distinguish root vs part-specific tooling

Agent 2 (100-200 lines):
- covers: rules, guides, features, platform, parts, problems
- grep for coding conventions docs, CLAUDE.md, .editorconfig, lint configs
- scan for consistent coding patterns, principles, anti-patterns
- scan test files to understand testing patterns, frameworks, test locations
- scan for repetitive patterns: how controllers/entities/routes are created
- look for existing docs, READMEs in subdirectories, inline "how to" comments
- read route definitions, page components, CLI commands, API endpoints
- scan for 3rd party integrations (payment, email, SMS, storage, search, auth)
- scan for observability (logging, tracing, monitoring, error tracking)
- scan for cloud resources (Cloud Run, GCS, Pub/Sub, Lambda, S3, etc.)
- for each monorepo part: read package.json, scan entry points, identify patterns
- check for ADRs, CHANGELOG, postmortems, solved problem docs
- MONOREPO: identify per-part rules, per-part guides

Each agent returns its output in `### Preview Format` (bullet-point outlines per file, NOT full documentation).

IMPORTANT: agents produce OUTLINES (3-8 bullets per doc), not full docs. Full docs are written in Phase 3.

Wait for both agents using TaskOutput(block=true), then proceed to `Step 2.2`.

### Step 2.2 - Assemble Preview

Combine both agent results into `.docs-state.tmp` after the header, prefixed with `--- PREVIEW ---`.

SINGLE REPO: merge platform findings into the architecture.md preview entry.

### Step 2.3 - Show Preview

Read `.docs-state.tmp` and display the preview section (everything after `--- PREVIEW ---`) to the user.

### Step 2.4 - Interactive Menu

After showing the preview, display this menu:

```
What's next?
1> deepen   - launch agents again to find gaps and enrich the preview
2> adjust   - tell me what to add, remove, or change
3> generate - preview looks good, create the docs
```

User can type just "1"-"3" OR add details: "1, dig deeper into the auth flow", etc.

Option 1 - deepen:
- Go back to `Step 2.1` with current preview as context for agents
- If user gave direction, focus agents on that specific area
- If no direction, agents look for gaps in the current preview
- After updating preview, return to MENU

Option 2 - adjust:
- User provides free text describing changes (add feature X, remove concept Y, rename Z, etc.)
- Apply the changes directly to the preview in `.docs-state.tmp`
- Show updated preview
- Return to MENU

Option 3 - generate:
- Update state: `phase: 3`
- Proceed to `## Phase 3`

---

## Phase 3 - Generate

Create the `docs/` folder and write all files based on the APPROVED PREVIEW.

### Step 3.1 - Create folder structure

Create directories based on project type and selected docs (only include docs that were selected):

For single repo:
```
docs/
├── overview.md                          (always)
├── architecture.md                      (always)
├── repo.md                              (always)
├── concepts.md                          (if selected)
├── db.md                                (if selected)
├── cicd.md                              (if selected)
├── rules.md                             (if selected)
├── guides/                              (if selected)
│   └── {topic}.md
├── features/                            (if selected)
│   └── {feature-name}.md
└── problems/                            (if selected)
```

For monorepo, add:
```
docs/
├── platform/                            (if selected)
│   ├── integrations.md
│   ├── observability.md
│   └── cloud-services.md
└── parts/                               (if selected)
    └── {part-name}/
        ├── overview.md
        ├── rules.md
        └── guides/
            └── {topic}.md
```

### Step 3.2 - Launch Generation Agents

Read `.docs-state.tmp` to get the approved preview. Launch agents in PARALLEL using `Task` with `subagent_type: "general-purpose"` and `run_in_background: true`. Each agent writes doc files directly to `docs/`. Each agent MUST reply with ONLY "done" when finished.

Launch one agent per selected doc type (up to 12 agents). Each agent receives in its prompt:
- the approved preview for its doc(s) (copy relevant section from .docs-state.tmp)
- the project type and parts list
- the doc writing rules below
- the `### Metadata Format` template
- its specific scanning instructions (see below)

Wait for all agents using TaskOutput(block=true), then proceed to `Step 3.3`.

Doc writing rules (include in every agent prompt):
- Be concise, use bullet points and tables
- Reference actual codebase file paths
- Use ASCII diagrams generously (box-drawing chars: ─ │ ┌ ┐ └ ┘ ├ ┤). architecture.md should have multiple diagrams (request lifecycle, data flow, deploy topology, auth flow, etc.). Other docs should also include diagrams when they help explain flows or relationships.
- No bold text, no emojis
- The preview bullets are the OUTLINE - expand each into proper documentation
- overview.md MUST include a doc index listing all generated files with 1-line descriptions
- EVERY .md file MUST end with a metadata section (see Metadata Format)

Per-agent scanning instructions:

overview agent → `docs/overview.md`:
- Read README.md, package.json, top-level config files

architecture agent → `docs/architecture.md`:
- Use Grep for entry points, route definitions, main exports, API calls between parts
- Identify all diagrammable flows: request lifecycle, data pipelines, auth flow, deploy pipeline, event/message flows, dependency graph
- Aim for 3-6 ASCII diagrams minimum

concepts agent → `docs/concepts.md`:
- Use Grep for type definitions, interfaces, enums, DB models
- Document domain entities, relationships, key business rules

repo agent → `docs/repo.md`:
- Read package.json, tsconfig, docker-compose, Makefile, scripts/
- Use Glob to map folder structure
- Scan for tooling configs (eslint, prettier, husky, etc.)
- Use Grep for env var references, read .env.example
- MONOREPO: distinguish root vs part-specific tooling

db agent → `docs/db.md`:
- Use Grep for DB schemas, ORM models, migrations, seeds
- Read DB config files, scan for caching layer

cicd agent → `docs/cicd.md`:
- Read .github/workflows/, CI config files
- Use Grep for deploy scripts

rules agent → `docs/rules.md`:
- Use Grep for conventions docs, coding patterns
- MONOREPO: identify per-part rules

guides agent → `docs/guides/*.md`:
- Scan for repetitive patterns, test files, existing docs/READMEs
- MONOREPO: distinguish root vs part-specific guides

features agent → `docs/features/*.md`:
- Read route definitions, page components, CLI commands, API endpoints

platform agent → `docs/platform/*.md` (monorepo) or merged into architecture.md (single):
- Scan for 3rd party integrations, observability setup, cloud resources

parts agent (monorepo only) → `docs/parts/{name}/*.md`:
- For each part: read package.json, scan entry points, identify patterns

problems agent → `docs/problems/*.md`:
- Check for existing ADRs, CHANGELOG, postmortems

### Step 3.3 - Align Docs

Run `python3 /home/lucas/_custom/repos/github_lucasvtiradentes/lvt-spec/.claude/commands/align-docs.py docs/` to auto-fix alignment issues in tables and ASCII diagrams. If unfixable issues remain, fix them manually and re-run until clean.

### Step 3.4 - Cleanup

1. Delete `.docs-state.tmp`
2. Show the final folder structure with file count
3. Tell user: "Done! Generated {N} files in docs/. Review them and adjust as needed."

---

## Reference

### Single Repo vs Monorepo

| Output           | Single Repo                            | Monorepo                               |
|------------------|----------------------------------------|----------------------------------------|
| overview.md      | yes                                    | yes                                    |
| architecture.md  | yes (includes platform findings)       | yes (standalone)                       |
| repo.md          | yes                                    | yes                                    |
| concepts.md      | skippable                              | skippable                              |
| db.md            | skippable                              | skippable                              |
| cicd.md          | skippable                              | skippable                              |
| rules.md         | skippable                              | skippable                              |
| guides/          | skippable                              | skippable (part guides live in parts/) |
| features/        | skippable                              | skippable                              |
| platform/        | N/A (merged into architecture.md)      | skippable (3 files)                    |
| parts/           | N/A                                    | skippable (overview + rules + guides)  |
| problems/        | skippable                              | skippable                              |

### Preview Format

The preview is PER-FILE with bullet points. Each file entry should ALSO include related docs and sources when known (lines starting with `>` are metadata hints so Phase 3 can write metadata without re-scanning).

```
--- PREVIEW ---

overview.md:
  - project: {name} - {description}
  - related repos: {repo-a}, {repo-b}
  - doc index: {N} files across docs/

architecture.md:
  - entry: {entry point} → {main flow}
  - diagrams: request lifecycle, data flow, deploy topology, {other identified flows}
  - data flow: {part} → {part} → {part}
  - external integrations: {service}, {service}, {service}
  - deployment: {how/where deployed}

concepts.md:
  - {concept}: {1-line description}
  - {concept}: {1-line description}
  - {concept}: {1-line description}

repo.md:
  - stack: {language}, {framework}, {ORM}, {DB}
  - folder structure: {key dirs and what they contain}
  - tooling: {eslint (root + api), prettier (root only), husky, lint-staged, ...}
  - scripts: {available commands from Makefile/package.json}
  - env vars: {VAR_1}, {VAR_2}, {VAR_3} (+ {N} more)
  - services: {service}:{port}, {service}:{port}
  - setup: {key steps to run locally}

db.md:
  - entities: {entity1}, {entity2}, {entity3} (+ {N} more)
  - key relationships: {entity} → {entity}, {entity} → {entity}
  - config: {pooling, replicas, timeouts}
  - migrations: {count} migrations, {strategy}
  - seeds: {how seeding works}
  - caching: {redis/in-memory, strategy}
  - patterns: {soft deletes, views, indexes, etc.}

cicd.md:
  - pipelines: {pipeline 1}, {pipeline 2}
  - deploy: {environments and targets}
  - secrets: {required secrets}
  - branch strategy: {strategy description}

rules.md:
  - principles: {principle 1}, {principle 2}
  - conventions: {convention 1}, {convention 2}
  - anti-patterns: {anti-pattern 1}, {anti-pattern 2}

guides/{topic}.md:
  - {bullet 1}
  - {bullet 2}
  - {bullet 3}

features/{feature-name}.md:
  - {bullet 1}
  - {bullet 2}
  - {bullet 3}

platform/:                              (monorepo only)
  integrations.md:
    - {service}: {purpose} ({N} integrations total)
    - {service}: {purpose}
  observability.md:
    - logging: {framework}
    - tracing: {framework}
    - monitoring: {tools}
  cloud-services.md:
    - {service}: {purpose}
    - {service}: {purpose}

parts/{name}/:                          (monorepo only)
  overview.md:
    - {what it does}, entry: {file}
    - stack: {part-specific stack}
  rules.md:
    - {part-specific rules that override/extend root}
  guides/{topic}.md:
    - {bullet 1}
    - {bullet 2}

problems/:
  - (empty on first gen - grows over time as problems are solved)

(metadata hints example)
features/booking.md:
  - availability check → hold → payment → confirm
  - cancellation policies: flexible, moderate, strict
  > related docs: concepts.md, features/auth.md, parts/api/overview.md
  > related sources: src/features/booking/, src/models/booking.model.ts, src/routes/booking.routes.ts
```

### Metadata Format

Appended at the bottom of every generated .md file:

```md
---

related docs:
- docs/concepts.md - booking entity definition, states
- docs/features/auth.md - user must be authenticated to book
- docs/parts/api/overview.md - booking endpoints live here

related sources:
- src/features/booking/ - booking module root
- src/features/booking/service.ts - core booking logic
- src/models/booking.model.ts - DB model
- src/routes/booking.routes.ts - API endpoints
- tests/booking/ - booking tests
```

Rules:
- related docs: other docs in docs/ that THIS doc depends on (unidirectional, no back-links)
- related sources: actual codebase files AND folders relevant to this doc's topic
- list folders when the whole directory is relevant, list specific files when only that file matters
- keep it focused: only list things that are directly relevant, not tangentially related
- overview.md does NOT need related docs (it IS the index) but should list key source files/folders

---

## Important Rules

- ALWAYS update `.docs-state.tmp` after completing each sub-step
- If the user interrupts and runs `/gen-docs` again, `## Phase 0` will resume from the last saved state
- Do NOT create files that were not selected in `Step 1.3`
- The preview in `.docs-state.tmp` is the SOURCE OF TRUTH for `## Phase 3` - only generate what's in the preview
- Phase 2 uses 2 Explore agents (compact outlines returned via TaskOutput). Phase 3 uses up to 12 general-purpose agents (full docs written to files). NEVER launch 12 agents in Phase 2.
- Step 2.2 is done by the MAIN agent (combines 2 agent results into .docs-state.tmp).
