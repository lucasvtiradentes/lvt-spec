# Gen Docs

Generate structured project documentation for AI context.

```
┌─────────────┐    ┌─────────────┐    ┌──────────────────────────────┐    ┌─────────────┐
│  PHASE 0    │    │  PHASE 1    │    │  PHASE 2                     │    │  PHASE 3    │
│  Resume     │    │  Setup      │    │  Preview Loop                │    │  Generate   │
│             │    │             │    │                              │    │             │
│ read .tmp   │───>│ project     │───>│ 2.1 launch agents → scan    │───>│ write docs/ │
│ resume or   │    │ type?       │    │ 2.2 build preview in .tmp   │    │ from approved│
│ start fresh │    │ skip docs?  │    │ 2.3 show preview to user    │    │ preview     │
│             │    │             │    │ 2.4 ask: deepen/adjust/go   │    │             │
│             │    │             │    │     ↻ loop until "go"       │    │             │
└─────────────┘    └─────────────┘    └──────────────────────────────┘    └─────────────┘
```

## State File

All progress is tracked in `.gen-docs-state.tmp` at the project root.

Phase 1 format:
```
phase: 1
type: monorepo
docs: overview,architecture,concepts,stack,data-model,environment,rules,features,components,ai
```

Phase 2+ format (preview appended):
```
phase: 2
type: monorepo
docs: overview,architecture,concepts,stack,data-model,environment,rules,features,components,ai

--- PREVIEW ---

overview.md:
  - project: My App - description here
  - related repos: repo-a, repo-b
  - doc index: 12 files across docs/

features/auth.md:
  - email/password + Google OAuth
  - JWT with refresh rotation
  - role-based: guest, host, admin

features/booking.md:
  - availability check → hold → payment → confirm
  - cancellation policies: flexible, moderate, strict

...etc
```

---

## Phase 0 - Resume Check

1. Check if `.gen-docs-state.tmp` exists in the project root
2. If it EXISTS:
   - Read it and parse the phase number
   - Use `AskUserQuestion` to ask:
     - question: "Found existing gen-docs session at phase {N}. What do you want to do?"
     - options:
       - "Resume from phase {N}" (Recommended)
       - "Start fresh (delete state)"
   - If resume: jump to the saved phase
   - If fresh: delete `.gen-docs-state.tmp`, proceed to Phase 1
3. If it does NOT exist:
   - Proceed to Phase 1

---

## Phase 1 - Setup

### Step 1: Ask project type

Use `AskUserQuestion`:
- question: "What type of project is this?"
- header: "Project type"
- options:
  - label: "Single Repo"
    description: "One language/concern, personal projects, libraries, single-service apps"
  - label: "Monorepo"
    description: "Multiple components (api, frontend, infra), multi-team, multiple package.json"

### Step 2: Ask which docs to SKIP

All docs are generated by default. We ask the user what to SKIP (inverted question).
This way the user only checks the few they don't want instead of checking everything.

Use a SINGLE `AskUserQuestion` call with 2 questions (all multiSelect: true).
The tool supports up to 4 questions per call, each with up to 4 options.

Question 1:
- question: "All docs are generated by default. Check any you want to SKIP:"
- header: "Skip docs?"
- multiSelect: true
- options:
  - label: "Skip concepts.md"     description: "Domain glossary (skip if trivial domain)"
  - label: "Skip data-model.md"   description: "DB schema, entity relationships (skip if no DB)"
  - label: "Skip environment.md"  description: "How to run locally, env vars, docker, seeds"
  - label: "Skip features/"       description: "One doc per product feature"

Question 2:
- question: "Any of these to skip too?"
- header: "Skip more?"
- multiSelect: true
- options (if SINGLE REPO):
  - label: "Skip rules/"          description: "Conventions, anti-patterns, principles, testing"
  - label: "Skip ai/"             description: "AI knowledge: decisions log + solved problems"
- options (if MONOREPO, add one more):
  - label: "Skip rules/"          description: "Conventions, anti-patterns, principles, testing"
  - label: "Skip ai/"             description: "AI knowledge: decisions log + solved problems"
  - label: "Skip components/"     description: "Per-component docs with overview + rules"

NOTE: overview.md, architecture.md, and stack.md are ALWAYS generated (not skippable).
The full list of docs to generate = all docs MINUS whatever the user checked to skip.
If user checks nothing: all docs are generated (most common case).

### Step 3: Save state

Write `.gen-docs-state.tmp`:
```
phase: 2
type: {monorepo|single}
docs: {comma-separated list of selected docs}
```

Tell the user: "Setup complete. Selected {N} doc types for {type} project. Launching discovery agents..."

Proceed to Phase 2.

---

## Phase 2 - Preview Loop

This phase builds a preview of ALL docs that will be generated. The user reviews and iterates until satisfied.

### Step 2.1 - Launch Discovery Agents

Launch multiple agents in PARALLEL using the `Task` tool. Each agent scans the codebase for a specific doc topic and returns a concise outline of what that doc will contain.

IMPORTANT: On the FIRST run, agents scan the codebase from scratch. On subsequent runs (when user picks "Deepen"), agents receive the current preview as context and focus on finding GAPS and missing information.

Launch one agent per selected doc type. Each agent gets:
- the project type (monorepo/single)
- the list of selected docs (so it knows the full picture)
- if deepening: the current preview content for its topic

Agent tasks by doc type:

overview agent:
- Read README.md, package.json (or equivalent), top-level config files
- Return: project name, description, purpose, related repos, key scripts

architecture agent:
- Use Glob to map full folder tree, use Grep to find entry points, route definitions, main exports
- Return: components, how they connect, data flow, external integrations, deployment info

concepts agent:
- Use Grep to search for type definitions, interfaces, enums, DB models
- Return: domain entities with 1-line descriptions, their relationships, key business rules

stack agent:
- Read package.json, pyproject.toml, go.mod, Gemfile, tsconfig, docker-compose, etc.
- Return: languages, frameworks, key dependencies, build tools, why each matters

data-model agent:
- Use Grep to find DB schemas, migrations, ORM models, SQL files
- Return: tables/collections, relationships, key constraints

environment agent:
- Use Grep for env var references (process.env, os.environ, etc.), read docker-compose, .env.example
- Return: required env vars, services, ports, setup steps

rules agent:
- Use Grep to find linting configs, .editorconfig, existing conventions, test files
- Return: coding patterns, naming conventions, test frameworks, consistent anti-patterns found in code

features agent:
- Read route definitions, page components, CLI commands, API endpoints
- Return: list of distinct features, each with name + 3-5 bullet points describing scope

components agent (monorepo only):
- For each top-level component dir: read its package.json, scan entry points
- Return: per-component summary (what it does, stack, key patterns, conventions)

ai agent:
- Check for existing decision docs, ADRs, CHANGELOG
- Return: any existing decisions or solved problems found (usually empty on first gen)

### Step 2.2 - Build Preview

Collect all agent results and assemble the preview. Write it to `.gen-docs-state.tmp` after the header section.

The preview format is PER-FILE with bullet points:

```
--- PREVIEW ---

overview.md:
  - project: {name} - {description}
  - related repos: {repo-a}, {repo-b}
  - doc index: {N} files across docs/

architecture.md:
  - entry: {entry point} → {main flow}
  - data flow: {component} → {component} → {component}
  - external integrations: {service}, {service}, {service}
  - deployment: {how/where deployed}

concepts.md:
  - {concept}: {1-line description}
  - {concept}: {1-line description}
  - {concept}: {1-line description}

stack.md:
  - {language} across {scope}
  - {framework}, {framework}, {ORM}, {DB}
  - testing: {test framework} + {e2e framework}
  - infra: {local setup}, {prod setup}

data-model.md:
  - {table}: {columns summary}, relates to {other tables}
  - {table}: {columns summary}, relates to {other tables}

environment.md:
  - env vars: {VAR_1}, {VAR_2}, {VAR_3} (+ {N} more)
  - services: {service}:{port}, {service}:{port}
  - setup: {key steps summary}

rules/:
  principles.md:
    - {principle 1}
    - {principle 2}
  conventions.md:
    - {convention 1}
    - {convention 2}
  anti-patterns.md:
    - {anti-pattern 1}
    - {anti-pattern 2}
  testing.md:
    - {framework}, tests in {location}
    - {testing pattern}

features/{feature-name}.md:
  - {bullet 1}
  - {bullet 2}
  - {bullet 3}

features/{feature-name}.md:
  - {bullet 1}
  - {bullet 2}
  - {bullet 3}

components/{name}/:                    (monorepo only)
  overview.md:
    - {what it does}, entry: {file}
    - stack: {component-specific stack}
  rules/conventions.md:
    - {convention 1}
    - {convention 2}
  rules/anti-patterns.md:
    - {anti-pattern 1}

ai/:
  decisions.md:
    - (empty template - grows over time)
  problems/:
    - (empty - grows over time)
```

Each file entry in the preview should ALSO include related docs and sources when known:

```
features/booking.md:
  - availability check → hold → payment → confirm
  - cancellation policies: flexible, moderate, strict
  > related docs: concepts.md, features/auth.md, components/api/overview.md
  > related sources: src/features/booking/, src/models/booking.model.ts, src/routes/booking.routes.ts
```

Lines starting with `>` are metadata hints. Agents collect these during discovery so Phase 3 can write the full metadata section without re-scanning.

If deepening: MERGE new findings into existing preview (add new bullets, don't remove existing ones unless they were wrong).

### Step 2.3 - Show Preview

Display the full preview to the user in a readable format.

### Step 2.4 - Ask User

Use `AskUserQuestion`:
- question: "Review the preview above. What do you want to do?"
- header: "Preview"
- options:
  - label: "Deepen"
    description: "Launch agents again to find gaps and enrich the preview"
  - label: "Adjust"
    description: "I'll tell you what to add, remove, or change"
  - label: "Generate docs"
    description: "Preview looks good, generate the actual docs now"

If user picks "Deepen":
- Go back to Step 2.1 with current preview as context for agents
- Agents focus on finding things they missed in the first pass

If user picks "Adjust":
- User provides free text describing changes (add feature X, remove concept Y, rename Z, etc.)
- Apply the changes directly to the preview in `.gen-docs-state.tmp`
- Show updated preview
- Go back to Step 2.4 (ask again)

If user picks "Generate docs":
- Update state: `phase: 3`
- Proceed to Phase 3

---

## Phase 3 - Generate

Create the `docs/` folder and write all files based on the APPROVED PREVIEW.

### 3.1 - Launch Generation Agents

Launch agents in PARALLEL to write the actual doc files. Each agent receives:
- the approved preview for its doc(s)
- the project type
- access to the codebase for referencing real file paths and code

Each agent writes complete, production-quality documentation following these rules:
- Be concise, use bullet points and tables
- Reference actual codebase file paths
- Use ASCII diagrams for architecture (box-drawing chars: ─ │ ┌ ┐ └ ┘ ├ ┤)
- No bold text, no emojis
- The preview bullets are the OUTLINE - expand each bullet into proper documentation
- overview.md MUST include a doc index section listing all generated files with 1-line descriptions
- EVERY generated .md file MUST end with a metadata section (see format below)

Metadata section format (appended at the bottom of every doc file):

```md
---

related docs:
- docs/concepts.md - booking entity definition, states
- docs/features/auth.md - user must be authenticated to book
- docs/components/api/overview.md - booking endpoints live here

related sources:
- src/features/booking/ - booking module root
- src/features/booking/service.ts - core booking logic
- src/models/booking.model.ts - DB model
- src/routes/booking.routes.ts - API endpoints
- tests/booking/ - booking tests
```

Rules for the metadata section:
- related docs: other docs in docs/ that THIS doc depends on (unidirectional, no back-links)
- related sources: actual codebase files AND folders relevant to this doc's topic
- list folders when the whole directory is relevant, list specific files when only that file matters
- keep it focused: only list things that are directly relevant, not tangentially related
- overview.md does NOT need related docs (it IS the index) but should list key source files/folders

### 3.2 - Create folder structure

Based on project type and selected docs, create directories and write all files.

For single repo:
```
docs/
├── overview.md
├── architecture.md
├── concepts.md
├── stack.md
├── data-model.md
├── environment.md
├── rules/
│   ├── principles.md
│   ├── conventions.md
│   ├── anti-patterns.md
│   └── testing.md
├── features/
│   └── {feature-name}.md (one per feature in preview)
└── ai/
    ├── decisions.md
    └── problems/
```

For monorepo, add:
```
docs/
└── components/
    └── {component-name}/
        ├── overview.md
        └── rules/
            ├── conventions.md
            └── anti-patterns.md
```

### 3.3 - Cleanup

1. Delete `.gen-docs-state.tmp`
2. Show the final folder structure with file count
3. Tell user: "Done! Generated {N} files in docs/. Review them and adjust as needed."

---

## Important Rules

- ALWAYS update `.gen-docs-state.tmp` after completing each sub-step
- If the user interrupts and runs `/gen-docs` again, Phase 0 will resume from the last saved state
- Do NOT create files that were not selected in Phase 1
- For rules/: always create all 4 files (principles, conventions, anti-patterns, testing) if rules/ was selected
- For ai/: create decisions.md with empty template and empty problems/ folder
- For features/: create one .md file per feature listed in the approved preview
- For components/: create one folder per component listed in the approved preview (monorepo only)
- The preview in `.gen-docs-state.tmp` is the SOURCE OF TRUTH for Phase 3 - only generate what's in the preview
- During "Adjust" in Phase 2.4, edit the preview directly - do NOT re-launch agents
- During "Deepen" in Phase 2.4, pass current preview to agents so they focus on gaps
